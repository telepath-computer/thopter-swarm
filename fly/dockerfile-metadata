# Redis Metadata Service Dockerfile
# Based on stock Redis Alpine, with persistence configuration using a fly volume expected at /data

FROM redis:alpine

# Create a custom entrypoint that fixes permissions on /data mount, then calls
# original entrypoint
RUN echo '#!/bin/sh' > /fix-permissions.sh && \
    echo '# Fix permissions on mounted volume' >> /fix-permissions.sh && \
    echo 'chown -R redis:redis /data' >> /fix-permissions.sh && \
    echo '# Call original entrypoint' >> /fix-permissions.sh && \
    echo 'exec docker-entrypoint.sh "$@"' >> /fix-permissions.sh && \
    chmod +x /fix-permissions.sh

ENTRYPOINT ["/fix-permissions.sh"]

# Redis server command and arguments - persistence, and bind to both IPv4 and IPv6
CMD ["redis-server", "--bind", "0.0.0.0", "::", "--protected-mode", "no", "--dir", "/data", "--appendonly", "yes", "--appendfsync", "everysec", "--save", ""]

EXPOSE 6379
