<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thopter <%= thopter.fly.id %> - Thopter Swarm Dashboard</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-nav">
        <h1>Thopter: <%= thopter.fly.id %></h1>
        <div class="nav-links">
          <a href="/" class="back-btn">‚Üê Back</a>
        </div>
      </div>
      <button onclick="window.location.reload()" class="refresh-btn">Refresh</button>
    </header>

    <main>
      <!-- Thopter Details Section -->
      <section class="thopter-detail-section">        
        <div class="thopter-detail-info">
          <div class="detail-grid">
            <!-- Fly Infrastructure Section -->
            <div class="detail-section">
              <h3>Infrastructure (Fly)</h3>
              
              <div class="detail-row">
                <div class="detail-label">Machine ID:</div>
                <div class="detail-value"><%= thopter.fly.id %></div>
              </div>
              
              <div class="detail-row">
                <div class="detail-label">Machine Name:</div>
                <div class="detail-value"><%= thopter.fly.name %></div>
              </div>
              
              <div class="detail-row">
                <div class="detail-label">Machine State:</div>
                <div class="detail-value">
                  <span class="machine-state <%= formatters.stateClass(thopter.fly.machineState) %>">
                    <%= thopter.fly.machineState %>
                  </span>
                </div>
              </div>
              
              <div class="detail-row">
                <div class="detail-label">Region:</div>
                <div class="detail-value"><%= thopter.fly.region %></div>
              </div>
              
              <div class="detail-row">
                <div class="detail-label">Image:</div>
                <div class="detail-value"><%= thopter.fly.image %></div>
              </div>
              
              <div class="detail-row">
                <div class="detail-label">Created:</div>
                <div class="detail-value">
                  <%= formatters.absoluteTime(thopter.fly.createdAt) %> 
                  (<%= formatters.relativeTime(thopter.fly.createdAt) %>)
                </div>
              </div>
            </div>

            <!-- Hub Management Section -->
            <div class="detail-section">
              <h3>Hub Management</h3>
              
              <div class="detail-row">
                <div class="detail-label">Kill Requested:</div>
                <div class="detail-value">
                  <span class="<%= thopter.hub.killRequested ? 'kill-requested' : 'normal' %>">
                    <%= thopter.hub.killRequested ? 'Yes' : 'No' %>
                  </span>
                </div>
              </div>
            </div>

            <!-- Session Status Section -->
            <% if (thopter.session) { %>
              <div class="detail-section">
                <h3>Session Status</h3>
                
                <div class="detail-row">
                  <div class="detail-label">Claude State:</div>
                  <div class="detail-value">
                    <span class="claude-state <%= formatters.stateClass(thopter.session.claudeState) %>">
                      <%= thopter.session.claudeState %>
                    </span>
                  </div>
                </div>
                
                <div class="detail-row">
                  <div class="detail-label">Last Activity:</div>
                  <div class="detail-value">
                    <%= formatters.absoluteTime(thopter.session.lastActivity) %> 
                    (<%= formatters.relativeTime(thopter.session.lastActivity) %>)
                  </div>
                </div>
                
                <% if (thopter.session.idleSince) { %>
                  <div class="detail-row">
                    <div class="detail-label">Idle Since:</div>
                    <div class="detail-value">
                      <%= formatters.absoluteTime(thopter.session.idleSince) %> 
                      (<%= formatters.relativeTime(thopter.session.idleSince) %>)
                    </div>
                  </div>
                <% } %>
              </div>
            <% } else { %>
              <div class="detail-section">
                <h3>Session Status</h3>
                <div class="detail-row">
                  <div class="detail-value no-session">
                    No observer data - thopter may not be responding
                  </div>
                </div>
              </div>
            <% } %>

            <!-- GitHub Context Section -->
            <% if (thopter.github) { %>
              <div class="detail-section">
                <h3>GitHub Context</h3>
                
                <div class="detail-row">
                  <div class="detail-label">Repository:</div>
                  <div class="detail-value">
                    <a href="<%= formatters.gitHubUrl(thopter.github.repository) %>" target="_blank">
                      <%= thopter.github.repository %>
                    </a>
                  </div>
                </div>
                
                <div class="detail-row">
                  <div class="detail-label">Issue:</div>
                  <div class="detail-value">
                    <a href="<%= formatters.gitHubUrl(thopter.github.repository, thopter.github.issueNumber) %>" target="_blank">
                      #<%= thopter.github.issueNumber %>: <%= thopter.github.issueTitle %>
                    </a>
                  </div>
                </div>
                
                <div class="detail-row">
                  <div class="detail-label">Work Branch:</div>
                  <div class="detail-value">
                    <span class="branch-name"><%= helpers.getWorkBranch(thopter) %></span>
                  </div>
                </div>
                
                <div class="detail-row">
                  <div class="detail-label">Mentioned By:</div>
                  <div class="detail-value"><%= thopter.github.mentionAuthor %></div>
                </div>
                
                <div class="detail-row">
                  <div class="detail-label">Mention Location:</div>
                  <div class="detail-value"><%= thopter.github.mentionLocation %></div>
                </div>
              </div>
            <% } else { %>
              <div class="detail-section">
                <h3>GitHub Context</h3>
                <div class="detail-row">
                  <div class="detail-value no-context">
                    No GitHub context available
                  </div>
                </div>
              </div>
            <% } %>

            <!-- Orphan Status Section -->
            <% const orphanStatus = helpers.getOrphanStatus(thopter); %>
            <% if (orphanStatus.isOrphan) { %>
              <div class="detail-section orphan-section">
                <h3>Orphan Status</h3>
                
                <div class="detail-row">
                  <div class="detail-label">Reason:</div>
                  <div class="detail-value orphan-reason">
                    <%= orphanStatus.reason %>
                  </div>
                </div>
                
                <% if (orphanStatus.lastSeen) { %>
                  <div class="detail-row">
                    <div class="detail-label">Last Seen:</div>
                    <div class="detail-value">
                      <%= formatters.absoluteTime(orphanStatus.lastSeen) %> 
                      (<%= formatters.relativeTime(orphanStatus.lastSeen) %>)
                    </div>
                  </div>
                <% } %>
                
                <% if (orphanStatus.secondsSinceLastUpdate) { %>
                  <div class="detail-row">
                    <div class="detail-label">Stale Duration:</div>
                    <div class="detail-value"><%= orphanStatus.secondsSinceLastUpdate %> seconds</div>
                  </div>
                <% } %>
              </div>
            <% } %>
          </div>
        </div>
        
        <!-- Thopter Actions -->
        <div class="thopter-actions-section">
          <div class="action-buttons">
            <% const terminalUrl = helpers.getWebTerminalUrl(thopter, process.env.APP_NAME, 7681); %>
            <a href="<%= terminalUrl %>" class="terminal-btn" target="_blank">Terminal</a>
            
            <% const sessionLogUrl = helpers.getWebTerminalUrl(thopter, process.env.APP_NAME, 7791); %>
            <a href="<%= sessionLogUrl %>" class="session-log-btn" target="_blank">Session Log</a>
            
            <% if (!thopter.hub.killRequested) { %>
              <form action="/agent/<%= thopter.fly.id %>/kill" method="POST" onsubmit="return confirmKill()" style="display: inline;">
                <button type="submit" class="kill-btn">Kill Thopter</button>
              </form>
            <% } else { %>
              <button class="kill-btn disabled" disabled>Killing...</button>
            <% } %>
          </div>
        </div>
      </section>

      <!-- Terminal Snapshot Section -->
      <% if (thopter.session && thopter.session.screenDump) { %>
        <section class="terminal-section">
          <h2>Terminal Snapshot</h2>
          <div class="terminal-timestamp">
            Last updated: <%= formatters.absoluteTime(thopter.session.lastActivity) %> (<%= formatters.relativeTime(thopter.session.lastActivity) %>)
          </div>
          <div class="terminal-container">
            <pre class="terminal-output"><%= thopter.session.screenDump %></pre>
          </div>
        </section>
      <% } else { %>
        <section class="terminal-section">
          <h2>Terminal Snapshot</h2>
          <div class="empty-state">
            <p>No terminal data available - thopter observer may not be running</p>
          </div>
        </section>
      <% } %>
    </main>
  </div>

  <script>
    function confirmKill() {
      return confirm('Are you sure you want to kill this thopter? This action cannot be undone.');
    }
  </script>
</body>
</html>