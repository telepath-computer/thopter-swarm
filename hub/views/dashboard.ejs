<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thopter Swarm Dashboard</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Thopter Swarm Dashboard</h1>
      <div class="header-controls">
        <!-- Operating Mode Indicator -->
        <div class="mode-indicator">
          <span class="mode-label">Mode:</span>
          <span class="mode-status <%= formatters.modeClass(operatingMode) %>">
            <%= operatingMode %>
          </span>
        </div>
        
        <!-- Pause/Resume Controls -->
        <div class="mode-controls">
          <% if (operatingMode === 'running') { %>
            <form action="/control/pause" method="POST">
              <button type="submit" class="control-btn pause-btn">Pause</button>
            </form>
          <% } else if (operatingMode === 'paused') { %>
            <form action="/control/resume" method="POST">
              <button type="submit" class="control-btn resume-btn">Resume</button>
            </form>
          <% } %>
        </div>
      </div>
    </header>

    <main>
      <!-- Golden Claudes Section -->
      <section class="golden-claudes-section">
        <h2>Golden Claudes (<%= goldenClaudes.length %>)</h2>
        
        <% if (goldenClaudes.length === 0) { %>
          <div class="empty-state">
            <p>No Golden Claude instances found.</p>
            <p>Create Golden Claudes using: <code>./fly/recreate-gc.sh [name]</code></p>
          </div>
        <% } else { %>
          <div class="table-container">
            <table class="gc-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Status</th>
                  <th>Machine ID</th>
                  <th>Terminal</th>
                </tr>
              </thead>
              <tbody>
                <% goldenClaudes.forEach(gc => { %>
                  <tr class="gc-row">
                    <td class="gc-name-cell">
                      <span class="gc-name">gc-<%= gc.name %></span>
                    </td>
                    <td class="status-cell">
                      <span class="gc-state <%= gc.state === 'running' ? 'state-running' : 'state-stopped' %>">
                        <%= gc.state %>
                      </span>
                    </td>
                    <td class="gc-id-cell">
                      <span class="machine-id" title="<%= gc.machineId %>">
                        <%= gc.machineId %>
                      </span>
                    </td>
                    <td class="terminal-cell">
                      <% if (gc.webTerminalUrl) { %>
                        <a href="<%= gc.webTerminalUrl %>" target="_blank" class="table-btn terminal-btn">
                          Terminal
                        </a>
                      <% } else { %>
                        <span class="no-data">—</span>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </section>

      <!-- Healthy Thopters Section -->
      <% if (healthyGroups.length > 0) { %>
        <section class="thopters-section">
          <h2>Healthy Thopters</h2>
          
          <% healthyGroups.forEach(group => { %>
            <div class="user-group">
              <h3 class="user-group-header">
                👤 <%= group.user %> (<%= group.thopters.length %> thopter<%= group.thopters.length === 1 ? '' : 's' %>)
              </h3>
              <div class="table-container">
                <table class="thopters-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Status</th>
                      <th>Age</th>
                      <th>Last Ping</th>
                      <th>Task</th>
                      <th></th>
                      <th></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% group.thopters.forEach(thopter => { %>
                      <tr class="thopter-row">
                        <td class="thopter-id-cell">
                          <a href="/agent/<%= thopter.fly.id %>" class="thopter-id-link">
                            <%= thopter.fly.id %>
                          </a>
                        </td>
                        <td class="status-cell">
                          <span class="thopter-state <%= formatters.stateClass(thopter.session?.claudeState || 'idle') %>">
                            <%= thopter.session?.claudeState || 'idle' %>
                          </span>
                          <% const idleDuration = formatters.idleDuration(thopter.session?.idleSince, thopter.session?.claudeState || 'idle'); %>
                          <% if (idleDuration) { %>
                            <span class="idle-duration">(<%= idleDuration %>)</span>
                          <% } %>
                        </td>
                        <td class="age-cell">
                          <span title="<%= formatters.absoluteTime(thopter.fly.createdAt) %>">
                            <%= formatters.relativeTime(thopter.fly.createdAt) %>
                          </span>
                        </td>
                        <td class="activity-cell">
                          <% if (thopter.session?.lastActivity) { %>
                            <span title="<%= formatters.absoluteTime(thopter.session.lastActivity) %>">
                              <%= formatters.relativeTime(thopter.session.lastActivity) %>
                            </span>
                          <% } else { %>
                            <span class="no-data">—</span>
                          <% } %>
                        </td>
                        <td class="repo-issue-cell">
                          <div class="repo-issue-content">
                            <% if (helpers.getRepository(thopter)) { %>
                              <div class="repo-line">
                                <a href="<%= formatters.gitHubUrl(helpers.getRepository(thopter)) %>" target="_blank">
                                  <%= helpers.getRepository(thopter) %>
                                </a>
                              </div>
                            <% } else { %>
                              <div class="repo-line no-data">—</div>
                            <% } %>
                            <% if (thopter.github && thopter.github.issueNumber) { %>
                              <div class="issue-line">
                                <a href="<%= formatters.gitHubUrl(thopter.github.repository, thopter.github.issueNumber) %>" target="_blank">
                                  #<%= thopter.github.issueNumber %>: <%= formatters.truncateText(thopter.github.issueTitle, 50) %>
                                </a>
                              </div>
                            <% } %>
                            <% const workBranch = helpers.getWorkBranch(thopter); %>
                            <% if (workBranch) { %>
                              <div class="branch-line">
                                <span class="branch-name"><%= workBranch %></span>
                              </div>
                            <% } %>
                          </div>
                        </td>
                        <td class="action-cell">
                          <% const terminalUrl = helpers.getWebTerminalUrl(thopter, process.env.APP_NAME, 7681); %>
                          <a href="<%= terminalUrl %>" class="table-btn terminal-btn" target="_blank" title="Open Web Terminal">
                            Terminal
                          </a>
                        </td>
                        <td class="action-cell">
                          <% const sessionLogUrl = helpers.getWebTerminalUrl(thopter, process.env.APP_NAME, 7791); %>
                          <a href="<%= sessionLogUrl %>" class="table-btn session-log-btn" target="_blank" title="View Session Logs">
                            Session Log
                          </a>
                        </td>
                        <td class="action-cell">
                          <% if (thopter.hub.killRequested) { %>
                            <button class="table-btn kill-btn disabled" disabled title="Thopter is being killed">
                              Killing...
                            </button>
                          <% } else { %>
                            <form action="/agent/<%= thopter.fly.id %>/kill" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to kill this thopter? This action cannot be undone.');">
                              <button type="submit" class="table-btn kill-btn" title="Kill Thopter">
                                Kill
                              </button>
                            </form>
                          <% } %>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            </div>
          <% }); %>
        </section>
      <% } %>

      <!-- Orphaned Thopters Section -->
      <% if (orphanedGroups.length > 0) { %>
        <section class="thopters-section orphaned-section">
          <h2>Orphaned Thopters</h2>
          
          <% orphanedGroups.forEach(group => { %>
            <div class="user-group">
              <h3 class="user-group-header">
                👤 <%= group.user %> (<%= group.thopters.length %> orphaned)
              </h3>
              <div class="table-container">
                <table class="thopters-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Machine State</th>
                      <th>Orphan Reason</th>
                      <th>Last Seen</th>
                      <th>Age</th>
                      <th>Task</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% group.thopters.forEach(thopter => { %>
                      <% const orphanStatus = helpers.getOrphanStatus(thopter); %>
                      <tr class="thopter-row orphaned">
                        <td class="thopter-id-cell">
                          <a href="/agent/<%= thopter.fly.id %>" class="thopter-id-link">
                            <%= thopter.fly.id %>
                          </a>
                          <span class="orphaned-indicator" title="Orphaned: <%= orphanStatus.reason %>">⚠️</span>
                        </td>
                        <td class="status-cell">
                          <span class="machine-state <%= formatters.stateClass(thopter.fly.machineState) %>">
                            <%= thopter.fly.machineState %>
                          </span>
                        </td>
                        <td class="orphan-reason-cell">
                          <span class="orphan-reason"><%= orphanStatus.reason %></span>
                          <% if (orphanStatus.secondsSinceLastUpdate) { %>
                            <span class="stale-duration">(<%= orphanStatus.secondsSinceLastUpdate %>s ago)</span>
                          <% } %>
                        </td>
                        <td class="activity-cell">
                          <% if (orphanStatus.lastSeen) { %>
                            <span title="<%= formatters.absoluteTime(orphanStatus.lastSeen) %>">
                              <%= formatters.relativeTime(orphanStatus.lastSeen) %>
                            </span>
                          <% } else { %>
                            <span class="no-data">—</span>
                          <% } %>
                        </td>
                        <td class="age-cell">
                          <span title="<%= formatters.absoluteTime(thopter.fly.createdAt) %>">
                            <%= formatters.relativeTime(thopter.fly.createdAt) %>
                          </span>
                        </td>
                        <td class="repo-issue-cell">
                          <div class="repo-issue-content">
                            <% if (helpers.getRepository(thopter)) { %>
                              <div class="repo-line">
                                <a href="<%= formatters.gitHubUrl(helpers.getRepository(thopter)) %>" target="_blank">
                                  <%= helpers.getRepository(thopter) %>
                                </a>
                              </div>
                            <% } else { %>
                              <div class="repo-line no-data">—</div>
                            <% } %>
                            <% if (thopter.github && thopter.github.issueNumber) { %>
                              <div class="issue-line">
                                <a href="<%= formatters.gitHubUrl(thopter.github.repository, thopter.github.issueNumber) %>" target="_blank">
                                  #<%= thopter.github.issueNumber %>: <%= formatters.truncateText(thopter.github.issueTitle, 50) %>
                                </a>
                              </div>
                            <% } %>
                          </div>
                        </td>
                        <td class="action-cell">
                          <% if (thopter.fly.machineState === 'started') { %>
                            <form action="/agent/<%= thopter.fly.id %>/kill" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to kill this orphaned thopter?');">
                              <button type="submit" class="table-btn kill-btn" title="Kill Orphaned Thopter">
                                Kill
                              </button>
                            </form>
                          <% } else { %>
                            <span class="no-data">—</span>
                          <% } %>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            </div>
          <% }); %>
        </section>
      <% } %>

      <!-- Stopped Thopters Section -->
      <% if (stoppedGroups.length > 0) { %>
        <section class="thopters-section stopped-section">
          <h2>Stopped Thopters</h2>
          
          <% stoppedGroups.forEach(group => { %>
            <div class="user-group">
              <h3 class="user-group-header">
                👤 <%= group.user %> (<%= group.thopters.length %> stopped)
              </h3>
              <div class="table-container">
                <table class="thopters-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Machine State</th>
                      <th>Age</th>
                      <th>Task</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% group.thopters.forEach(thopter => { %>
                      <tr class="thopter-row stopped">
                        <td class="thopter-id-cell">
                          <span class="thopter-id">
                            <%= thopter.fly.id %>
                          </span>
                        </td>
                        <td class="status-cell">
                          <span class="machine-state <%= formatters.stateClass(thopter.fly.machineState) %>">
                            <%= thopter.fly.machineState %>
                          </span>
                        </td>
                        <td class="age-cell">
                          <span title="<%= formatters.absoluteTime(thopter.fly.createdAt) %>">
                            <%= formatters.relativeTime(thopter.fly.createdAt) %>
                          </span>
                        </td>
                        <td class="repo-issue-cell">
                          <div class="repo-issue-content">
                            <% if (helpers.getRepository(thopter)) { %>
                              <div class="repo-line">
                                <a href="<%= formatters.gitHubUrl(helpers.getRepository(thopter)) %>" target="_blank">
                                  <%= helpers.getRepository(thopter) %>
                                </a>
                              </div>
                            <% } else { %>
                              <div class="repo-line no-data">—</div>
                            <% } %>
                            <% if (thopter.github && thopter.github.issueNumber) { %>
                              <div class="issue-line">
                                <a href="<%= formatters.gitHubUrl(thopter.github.repository, thopter.github.issueNumber) %>" target="_blank">
                                  #<%= thopter.github.issueNumber %>: <%= formatters.truncateText(thopter.github.issueTitle, 50) %>
                                </a>
                              </div>
                            <% } %>
                          </div>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            </div>
          <% }); %>
        </section>
      <% } %>

      <!-- Empty State for No Thopters -->
      <% if (healthyGroups.length === 0 && orphanedGroups.length === 0 && stoppedGroups.length === 0) { %>
        <section class="thopters-section">
          <h2>Thopters (0)</h2>
          <div class="empty-state">
            <p>No thopters found.</p>
            <p>Thopters will appear here when they are spawned and running.</p>
          </div>
        </section>
      <% } %>

      <!-- Provision Requests Section -->
      <section class="requests-section">
        <h2>Recent Provision Requests (Last 5)</h2>
        
        <% if (provisionRequests.length === 0) { %>
          <div class="empty-state">
            <p>No recent provision requests.</p>
          </div>
        <% } else { %>
          <div class="table-container">
            <table class="requests-table">
              <thead>
                <tr>
                  <th>Request ID</th>
                  <th>Repository / Issue</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Thopter</th>
                </tr>
              </thead>
              <tbody>
                <% provisionRequests.forEach(request => { %>
                  <tr class="request-row">
                    <td class="request-id-cell">
                      <span class="request-id"><%= request.requestId.substring(0, 12) %>...</span>
                    </td>
                    <td class="repo-issue-cell">
                      <div class="repo-issue-content">
                        <div class="repo-line"><%= request.repository %></div>
                        <% if (request.github && request.github.issueNumber) { %>
                          <div class="issue-line">
                            <a href="<%= formatters.gitHubUrl(request.repository, request.github.issueNumber) %>" target="_blank">
                              #<%= request.github.issueNumber %>: <%= formatters.truncateText(request.github.issueTitle, 40) %>
                            </a>
                          </div>
                        <% } %>
                      </div>
                    </td>
                    <td class="status-cell">
                      <span class="request-status <%= formatters.requestStatusClass(request.status) %>">
                        <%= request.status %>
                      </span>
                    </td>
                    <td class="time-cell">
                      <span title="<%= formatters.absoluteTime(request.createdAt) %>">
                        <%= formatters.relativeTime(request.createdAt) %>
                      </span>
                    </td>
                    <td class="thopter-cell">
                      <% if (request.thopterId) { %>
                        <a href="/agent/<%= request.thopterId %>" class="thopter-id-link">
                          <%= request.thopterId.substring(0, 8) %>...
                        </a>
                      <% } else { %>
                        <span class="no-data">—</span>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </section>

      <!-- Destroy Requests Section -->
      <section class="requests-section">
        <h2>Recent Destroy Requests (Last 5)</h2>
        
        <% if (destroyRequests.length === 0) { %>
          <div class="empty-state">
            <p>No recent destroy requests.</p>
          </div>
        <% } else { %>
          <div class="table-container">
            <table class="requests-table">
              <thead>
                <tr>
                  <th>Request ID</th>
                  <th>Thopter</th>
                  <th>Source</th>
                  <th>Reason</th>
                  <th>Status</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                <% destroyRequests.forEach(request => { %>
                  <tr class="request-row">
                    <td class="request-id-cell">
                      <span class="request-id"><%= request.requestId.substring(0, 12) %>...</span>
                    </td>
                    <td class="thopter-cell">
                      <% if (request.thopterId) { %>
                        <a href="/agent/<%= request.thopterId %>" class="thopter-id-link">
                          <%= request.thopterId.substring(0, 8) %>...
                        </a>
                      <% } else { %>
                        <span class="no-data">—</span>
                      <% } %>
                    </td>
                    <td class="source-cell">
                      <span class="request-source"><%= request.source %></span>
                    </td>
                    <td class="reason-cell">
                      <%= request.reason ? formatters.truncateText(request.reason, 40) : '—' %>
                    </td>
                    <td class="status-cell">
                      <span class="request-status <%= formatters.requestStatusClass(request.status) %>">
                        <%= request.status %>
                      </span>
                    </td>
                    <td class="time-cell">
                      <span title="<%= formatters.absoluteTime(request.createdAt) %>">
                        <%= formatters.relativeTime(request.createdAt) %>
                      </span>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </section>

      <!-- Logs Information Section -->
      <section class="logs-section">
        <h2>Dashboard Logs</h2>
        
        <div class="logs-tip">
          <p>To view real-time logs for this dashboard:</p>
          <div class="command-box">
            <code id="logsCommand">fly logs --machine <%= process.env.FLY_MACHINE_ID || '<hub machine id here>' %></code>
          </div>
        </div>
      </section>

    </main>
  </div>

</body>
</html>