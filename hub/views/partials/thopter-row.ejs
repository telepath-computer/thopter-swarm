<%#
  Reusable thopter table row partial
  
  Expected variables:
  - thopter: ThopterState object
  - mode: 'healthy' | 'orphaned' | 'stopped'
  - formatters: formatting helper functions
  - helpers: thopter helper functions
  - process.env.APP_NAME: app name for URLs
%>

<tr class="thopter-row <%= mode %>">
  <td class="thopter-id-cell">
    <a href="/agent/<%= thopter.fly.id %>" class="thopter-id-link">
      <%= thopter.fly.id %>
    </a>
    <% if (mode === 'orphaned') { %>
      <% const orphanStatus = helpers.getOrphanStatus(thopter); %>
      <span class="orphaned-indicator" title="Orphaned: <%= orphanStatus.reason %>">⚠️</span>
    <% } %>
  </td>

  <td class="status-cell">
    <% if (mode === 'healthy') { %>
      <span class="thopter-state <%= formatters.stateClass(thopter.session?.claudeState || 'idle') %>">
        <%= thopter.session?.claudeState || 'idle' %>
      </span>
      <% const idleDuration = formatters.idleDuration(thopter.session?.idleSince, thopter.session?.claudeState || 'idle'); %>
      <% if (idleDuration) { %>
        <span class="idle-duration">(<%= idleDuration %>)</span>
      <% } %>
    <% } else { %>
      <span class="machine-state <%= formatters.stateClass(thopter.fly.machineState) %>">
        <%= thopter.fly.machineState %>
      </span>
    <% } %>
  </td>

  <% if (mode === 'orphaned') { %>
    <td class="orphan-reason-cell">
      <% const orphanStatus = helpers.getOrphanStatus(thopter); %>
      <span class="orphan-reason"><%= orphanStatus.reason %></span>
      <% if (orphanStatus.secondsSinceLastUpdate) { %>
        <span class="stale-duration">(<%= orphanStatus.secondsSinceLastUpdate %>s ago)</span>
      <% } %>
    </td>
    <td class="activity-cell">
      <% if (orphanStatus.lastSeen) { %>
        <span title="<%= formatters.absoluteTime(orphanStatus.lastSeen) %>">
          <%= formatters.relativeTime(orphanStatus.lastSeen) %>
        </span>
      <% } else { %>
        <span class="no-data">—</span>
      <% } %>
    </td>
  <% } else if (mode === 'healthy') { %>
    <td class="activity-cell">
      <% if (thopter.session?.lastActivity) { %>
        <span title="<%= formatters.absoluteTime(thopter.session.lastActivity) %>">
          <%= formatters.relativeTime(thopter.session.lastActivity) %>
        </span>
      <% } else { %>
        <span class="no-data">—</span>
      <% } %>
    </td>
  <% } %>

  <td class="age-cell">
    <span title="<%= formatters.absoluteTime(thopter.fly.createdAt) %>">
      <%= formatters.relativeTime(thopter.fly.createdAt) %>
    </span>
  </td>

  <td class="repo-issue-cell">
    <div class="repo-issue-content">
      <% if (helpers.getRepository(thopter)) { %>
        <div class="repo-line">
          <a href="<%= formatters.gitHubUrl(helpers.getRepository(thopter)) %>" target="_blank">
            <%= helpers.getRepository(thopter) %>
          </a>
        </div>
      <% } else { %>
        <div class="repo-line no-data">—</div>
      <% } %>
      <% if (thopter.github && thopter.github.issueNumber) { %>
        <div class="issue-line">
          <a href="<%= formatters.gitHubUrl(thopter.github.repository, thopter.github.issueNumber) %>" target="_blank">
            #<%= thopter.github.issueNumber %>: <%= formatters.truncateText(thopter.github.issueTitle, 50) %>
          </a>
        </div>
      <% } %>
      <% if (mode === 'healthy') { %>
        <% const workBranch = helpers.getWorkBranch(thopter); %>
        <% if (workBranch) { %>
          <div class="branch-line">
            <span class="branch-name"><%= workBranch %></span>
          </div>
        <% } %>
      <% } %>
    </div>
  </td>

  <% if (mode === 'healthy') { %>
    <td class="action-cell">
      <% const terminalUrl = helpers.getWebTerminalUrl(thopter, process.env.APP_NAME, 7681); %>
      <a href="<%= terminalUrl %>" class="table-btn terminal-btn" target="_blank" title="Open Web Terminal">
        Terminal
      </a>
    </td>
    <td class="action-cell">
      <% const sessionLogUrl = helpers.getWebTerminalUrl(thopter, process.env.APP_NAME, 7791); %>
      <a href="<%= sessionLogUrl %>" class="table-btn session-log-btn" target="_blank" title="View Session Logs">
        Session Log
      </a>
    </td>
    <td class="action-cell">
      <% if (thopter.hub.killRequested) { %>
        <button class="table-btn kill-btn disabled" disabled title="Thopter is being killed">
          Killing...
        </button>
      <% } else { %>
        <form action="/agent/<%= thopter.fly.id %>/kill" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to kill this thopter? This action cannot be undone.');">
          <button type="submit" class="table-btn kill-btn" title="Kill Thopter">
            Kill
          </button>
        </form>
      <% } %>
    </td>
  <% } else if (mode === 'orphaned') { %>
    <td class="action-cell">
      <% if (thopter.fly.machineState === 'started') { %>
        <form action="/agent/<%= thopter.fly.id %>/kill" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to kill this orphaned thopter?');">
          <button type="submit" class="table-btn kill-btn" title="Kill Orphaned Thopter">
            Kill
          </button>
        </form>
      <% } else { %>
        <span class="no-data">—</span>
      <% } %>
    </td>
  <% } %>
</tr>